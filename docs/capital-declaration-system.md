# מערכת הצהרות הון - תיעוד מלא

## תוכן עניינים
1. [סקירה כללית](#1-סקירה-כללית)
2. [מבנה בסיס הנתונים](#2-מבנה-בסיס-הנתונים)
3. [סטטוסים ומעברים](#3-סטטוסים-ומעברים)
4. [קטגוריות מסמכים](#4-קטגוריות-מסמכים)
5. [תהליך עבודה מלא](#5-תהליך-עבודה-מלא)
6. [דפי המערכת](#6-דפי-המערכת)
7. [פורטל הלקוח](#7-פורטל-הלקוח)
8. [מכתב ההצהרה](#8-מכתב-ההצהרה)
9. [ניהול קנסות](#9-ניהול-קנסות)
10. [תקשורת ותיעוד](#10-תקשורת-ותיעוד)
11. [שירותים וקבצים](#11-שירותים-וקבצים)
12. [הרשאות ואבטחה](#12-הרשאות-ואבטחה)

---

## 1. סקירה כללית

### מה המערכת עושה?
מערכת הצהרות הון מאפשרת למשרדי רואי חשבון לנהל את כל תהליך הצהרת ההון מול לקוחות:

1. **יצירת הצהרה** - יצירת מכתב בקשת מסמכים ללקוח
2. **שליחה ללקוח** - שליחת לינק לפורטל העלאה (ללא צורך בהתחברות)
3. **קבלת מסמכים** - הלקוח מעלה מסמכים לפי קטגוריות
4. **מעקב ובקרה** - צפייה בסטטוס, תזכורות, תיעוד תקשורת
5. **הגשה לרשות** - תיעוד ההגשה כולל צילום מסך
6. **ניהול קנסות** - במקרה של איחור

### יתרונות מרכזיים
- **ללא התחברות ללקוח** - גישה באמצעות לינק ייחודי (token)
- **מעקב אוטומטי** - המערכת מעדכנת סטטוס אוטומטית
- **היסטוריה מלאה** - כל שינוי סטטוס נשמר
- **ניהול קנסות** - מעקב מלא אחר קנסות וערעורים
- **תיעוד תקשורת** - לוג של כל שיחה/הודעה

---

## 2. מבנה בסיס הנתונים

### טבלה ראשית: `capital_declarations`

```sql
-- מידע בסיסי
id                      UUID PRIMARY KEY
tenant_id               UUID (multi-tenant)
created_by              UUID (מי יצר)
created_at              TIMESTAMPTZ
updated_at              TIMESTAMPTZ

-- פרטי איש קשר ראשי
contact_name            TEXT (שם הנמען)
contact_email           TEXT
contact_phone           TEXT
contact_phone_secondary TEXT
contact_id              UUID (קישור ל-tenant_contacts)

-- נמען חלופי (אם שולחים למישהו אחר)
recipient_mode          'main' | 'alternate'
recipient_name          TEXT
recipient_email         TEXT
recipient_phone         TEXT
recipient_contact_id    UUID

-- פרטי ההצהרה
tax_year                INTEGER (שנת מס)
declaration_date        DATE (תאריך ההצהרה)
subject                 TEXT (נושא - ברירת מחדל: "הצהרת הון")
google_drive_link       TEXT (לינק לתיקייה בגוגל דרייב)
notes                   TEXT (הערות פנימיות)

-- קישור ללקוח (אופציונלי, להיסטוריה)
client_id               UUID
group_id                UUID

-- סטטוס
status                  TEXT (10 סטטוסים אפשריים)

-- גישה לפורטל
public_token            TEXT UNIQUE (טוקן לגישה ציבורית)
portal_accessed_at      TIMESTAMPTZ (מתי נכנס לראשונה)
portal_access_count     INTEGER (כמה פעמים נכנס)

-- עדיפות והקצאה
priority                'normal' | 'urgent' | 'critical'
assigned_to             UUID (רו"ח אחראי)
assigned_at             TIMESTAMPTZ

-- תאריכי יעד
tax_authority_due_date              DATE (דד-ליין מרשות המסים)
tax_authority_due_date_document_path TEXT (צילום מסך הדרישה)
internal_due_date                   DATE (דד-ליין פנימי)

-- הגשה
submission_screenshot_path  TEXT (צילום מסך ההגשה)
submitted_at               TIMESTAMPTZ
was_submitted_late         BOOLEAN (האם הוגש באיחור)

-- קנסות
penalty_amount          NUMERIC (סכום הקנס)
penalty_status          'received' | 'appeal_submitted' | 'cancelled' | 'paid_by_client' | 'paid_by_office'
penalty_received_date   DATE
penalty_notes           TEXT
appeal_date             DATE
appeal_notes            TEXT
penalty_paid_date       DATE
penalty_paid_amount     NUMERIC
penalty_paid_by         'client' | 'office'

-- קישור למכתב
letter_id               UUID (קישור ל-generated_letters)
```

### טבלת מסמכים: `capital_declaration_documents`

```sql
id              UUID PRIMARY KEY
tenant_id       UUID
declaration_id  UUID (FK)
category        ENUM (7 קטגוריות)
file_name       TEXT
file_type       TEXT (pdf, jpeg, png)
file_size       INTEGER
storage_path    TEXT (נתיב ב-Storage)
notes           TEXT
uploaded_at     TIMESTAMPTZ
uploaded_by_ip  TEXT
```

### טבלת היסטוריית סטטוסים: `capital_declaration_status_history`

```sql
id              UUID PRIMARY KEY
tenant_id       UUID
declaration_id  UUID (FK)
from_status     TEXT (סטטוס קודם)
to_status       TEXT (סטטוס חדש)
notes           TEXT (הערה לשינוי)
changed_by      UUID (מי שינה)
changed_at      TIMESTAMPTZ
```

### טבלת תקשורת: `capital_declaration_communications`

```sql
id                  UUID PRIMARY KEY
tenant_id           UUID
declaration_id      UUID (FK)
communication_type  'letter' | 'phone_call' | 'whatsapp' | 'note'
direction           'outbound' | 'inbound'
subject             TEXT
content             TEXT
outcome             TEXT
letter_id           UUID (אם מכתב - קישור)
communicated_at     TIMESTAMPTZ
created_by          UUID
created_at          TIMESTAMPTZ
```

---

## 3. סטטוסים ומעברים

### 10 סטטוסים אפשריים

| סטטוס | תווית עברית | משמעות |
|-------|-------------|--------|
| `draft` | טיוטה | נוצר אך לא נשלח |
| `sent` | נשלח | המכתב נשלח ללקוח |
| `in_progress` | הלקוח התחיל | הלקוח נכנס לפורטל |
| `waiting_documents` | ממתין למסמכים | הלקוח התחיל להעלות |
| `documents_received` | מסמכים התקבלו | הלקוח סיים להעלות |
| `reviewing` | בבדיקה | רו"ח בודק המסמכים |
| `in_preparation` | בהכנה | מכינים את ההצהרה |
| `pending_approval` | ממתין לאישור | ממתין לאישור מנהל |
| `submitted` | הוגש | הוגש לרשות המסים |
| `waiting` | ממתין | בהמתנה (כללי) |

### מעברי סטטוס אוטומטיים (Triggers)

```
1. כניסה ראשונה לפורטל:
   sent → in_progress

2. העלאת מסמך (טריגר):
   אם 6 קטגוריות מלאות → reviewing
   אחרת → waiting_documents

3. לקוח לוחץ "סיימתי להעלות":
   * → documents_received
```

### מעברי סטטוס ידניים

```
draft → sent (שליחת המכתב)
in_progress → waiting_documents → documents_received
documents_received → reviewing → in_preparation → pending_approval → submitted
כל סטטוס → waiting (בהמתנה)
```

---

## 4. קטגוריות מסמכים

### 7 קטגוריות

| קטגוריה | תווית עברית | תיאור | צבע |
|---------|-------------|-------|-----|
| `bank` | בנק | אישורי יתרות, דפי חשבון | כחול |
| `real_estate` | נדל"ן | נסחי טאבו, שומות, חוזים | ירוק |
| `insurance` | קופות גמל וביטוח | דוחות פנסיה, ביטוחי חיים | צהוב |
| `vehicles` | רכבים | רישיון רכב, מימון | סגול |
| `abroad` | נכסים בחו"ל | חשבונות בנק, נכסים | טורקיז |
| `other` | נכסים/חובות נוספים | הלוואות, מניות, קרנות | ורוד |
| `general` | מסמכים כלליים | כל דבר אחר | אפור |

### סוגי קבצים מותרים
- PDF (`application/pdf`)
- JPEG (`image/jpeg`, `image/jpg`)
- PNG (`image/png`)
- **גודל מקסימלי**: 15MB

### מבנה Storage

```
capital-declarations/
  └── {declaration_id}/
      ├── bank/
      │   └── 1704067200000-statement.pdf
      ├── real_estate/
      │   └── 1704067300000-tabu.jpg
      ├── insurance/
      ├── vehicles/
      ├── abroad/
      ├── other/
      ├── general/
      ├── tax-authority-request.png    ← צילום דרישה
      └── submission-screenshot.png     ← צילום הגשה
```

---

## 5. תהליך עבודה מלא

### שלב 1: יצירת הצהרה

```
1. רו"ח נכנס ל: /capital-declaration
2. ממלא טופס:
   - שם איש קשר (חובה)
   - אימייל/טלפון
   - שנת מס
   - תאריך הצהרה
   - נושא
   - לינק גוגל דרייב (אופציונלי)
   - הערות (אופציונלי)
3. לוחץ "תצוגה מקדימה" לראות את המכתב
4. לוחץ "צור הצהרה + PDF"
```

### שלב 2: מה קורה בלחיצה על "צור"

```
1. נשמר רשומת איש קשר (tenant_contacts) אם חדש
2. נוצרת רשומת capital_declarations עם:
   - status = 'draft'
   - public_token = טוקן ייחודי (24 bytes base64)
3. נוצר מכתב HTML דרך templateService
4. נשמר ב-generated_letters
5. מופעל Edge Function ליצירת PDF
6. סטטוס משתנה ל-'sent'
7. מוצג פאנל שיתוף עם:
   - לינק לפורטל
   - אפשרות שליחה באימייל
   - אפשרות שמירה ב-Storage
```

### שלב 3: הלקוח מקבל לינק

```
לינק לדוגמה:
https://ticovision.vercel.app/capital-declaration/abc123xyz...

הלקוח לוחץ על הלינק ומגיע לפורטל (ללא התחברות)
```

### שלב 4: פורטל הלקוח

```
1. כניסה ראשונה:
   - מתעדכן portal_accessed_at
   - מתעדכן portal_access_count
   - סטטוס: sent → in_progress

2. הלקוח רואה:
   - שם המשרד
   - שנת מס ותאריך הצהרה
   - פס התקדמות (0-100%)
   - 7 כרטיסיות קטגוריות
   - הוראות העלאה

3. הלקוח מעלה מסמכים:
   - גרירה ושחרור או בחירת קובץ
   - יכול להעלות כמה קבצים בכל קטגוריה
   - יכול למחוק קבצים שהעלה

4. כשסיים, מסמן "סיימתי להעלות" ומאשר
   - סטטוס משתנה ל-documents_received
   - נרשם בהיסטוריה
```

### שלב 5: בדיקה והכנה (רו"ח)

```
1. רו"ח רואה בדשבורד שהמסמכים הגיעו
2. נכנס לדף פרטים (/capital-declarations/:id)
3. בודק את המסמכים בכל קטגוריה
4. משנה סטטוסים:
   - documents_received → reviewing
   - reviewing → in_preparation
   - in_preparation → pending_approval
5. מתעד תקשורת עם הלקוח אם צריך
```

### שלב 6: הגשה לרשות המסים

```
1. רו"ח לוחץ "הגש הצהרה"
2. מעלה צילום מסך של ההגשה
3. מסמן אם הוגש באיחור
4. סטטוס משתנה ל-submitted
5. אם באיחור - מתחיל מעקב קנסות
```

---

## 6. דפי המערכת

### דף יצירת הצהרה
**נתיב**: `/capital-declaration`
**קובץ**: `src/pages/CapitalDeclarationPage.tsx`

**שדות הטופס**:
| שדה | סוג | חובה | תיאור |
|-----|-----|------|-------|
| שם איש קשר | טקסט | כן | השלמה אוטומטית מאנשי קשר |
| אימייל | אימייל | לא | |
| טלפון ראשי | טלפון | לא | |
| טלפון משני | טלפון | לא | |
| מצב נמען | toggle | כן | ראשי/חלופי |
| שנת מס | בחירה | כן | השנה הנוכחית עד 5 שנים אחורה |
| תאריך הצהרה | תאריך | כן | ברירת מחדל: היום |
| נושא | טקסט | כן | ברירת מחדל: "הצהרת הון" |
| לינק גוגל דרייב | URL | לא | |
| הערות | textarea | לא | |
| לקוח משויך | בחירה | לא | להיסטוריה |
| קבוצה משויכת | בחירה | לא | להיסטוריה |

### דשבורד הצהרות
**נתיב**: `/capital-declarations`
**קובץ**: `src/pages/CapitalDeclarationsListPage.tsx`

**כרטיסיות סטטיסטיקה (7)**:
1. סה"כ הצהרות
2. קריטי (אדום)
3. דחוף (כתום)
4. ממתין
5. נשלח
6. בתהליך
7. הוגש

**פילטרים**:
- חיפוש טקסט (שם/אימייל)
- סטטוס (כולל "בתהליך פעיל")
- שנת מס
- עדיפות (מנהל בלבד)
- רו"ח מוקצה (מנהל בלבד)

**עמודות הטבלה**:
1. עדיפות (ניתן לעריכה למנהל)
2. שם איש קשר + לקוח
3. שנת מס
4. סטטוס
5. רו"ח מוקצה
6. דד-ליין רשות + ימים שנותרו
7. דד-ליין פנימי + ימים שנותרו
8. התקדמות מסמכים (X/6)
9. אינדיקטור איחור
10. סטטוס קנס
11. תקשורת אחרונה
12. מחיקה (סופר אדמין)

### דף פרטי הצהרה
**נתיב**: `/capital-declarations/:id`
**קובץ**: `src/pages/CapitalDeclarationDetailPage.tsx`

**חלקים בדף**:

**Header**:
- Badge עדיפות
- כפתור תזכורת WhatsApp
- כפתור תיעוד תקשורת
- כפתור שליחת תזכורת
- כפתור העתקת לינק פורטל
- כפתור פתיחת פורטל

**4 כרטיסי מידע**:
1. פרטי איש קשר
2. פרטי הצהרה (שנה, תאריך, נוצר)
3. סטטוס והקצאה
4. תאריכי יעד

**היסטוריה ותקשורת (2 עמודות)**:
- ציר זמן שינויי סטטוס
- היסטוריית תקשורת

**ניהול קנסות** (מוצג רק אחרי הגשה):
- טופס מלא לניהול קנס

**7 כרטיסי קטגוריות מסמכים**:
- כל קטגוריה עם:
  - אייקון וכותרת
  - רשימת מסמכים
  - כפתורי הורדה/מחיקה
  - תיאור הקטגוריה

---

## 7. פורטל הלקוח

**נתיב**: `/capital-declaration/:token`
**קובץ**: `src/pages/CapitalDeclarationPortal.tsx`

### מה הלקוח רואה

```
┌─────────────────────────────────────────────────────┐
│  [לוגו המשרד]        שם המשרד                       │
├─────────────────────────────────────────────────────┤
│                                                     │
│  שלום [שם הלקוח]!                                  │
│  הצהרת הון לשנת [שנה]                              │
│  תאריך: [תאריך]                                    │
│                                                     │
│  ════════════════════════════════                  │
│  התקדמות: ████████░░░░░░ 60%                      │
│  ════════════════════════════════                  │
│                                                     │
│  ┌─────────────────────────────────────────────┐  │
│  │ 📋 הוראות                                    │  │
│  │ העלו את המסמכים הבאים לפי הקטגוריות        │  │
│  └─────────────────────────────────────────────┘  │
│                                                     │
│  ┌─────────────────────────────────────────────┐  │
│  │ 🏦 בנק                              [2 קבצים]│  │
│  │ ──────────────────────────────────────────── │  │
│  │ [גרור קבצים לכאן או לחץ לבחירה]             │  │
│  │ ──────────────────────────────────────────── │  │
│  │ • statement.pdf (150KB) [🗑️]                │  │
│  │ • balance.jpg (80KB) [🗑️]                   │  │
│  └─────────────────────────────────────────────┘  │
│                                                     │
│  ┌─────────────────────────────────────────────┐  │
│  │ 🏠 נדל"ן                            [0 קבצים]│  │
│  │ ──────────────────────────────────────────── │  │
│  │ [גרור קבצים לכאן או לחץ לבחירה]             │  │
│  └─────────────────────────────────────────────┘  │
│                                                     │
│  ... (עוד 5 קטגוריות) ...                         │
│                                                     │
│  ┌─────────────────────────────────────────────┐  │
│  │ ☑️ סיימתי להעלות את כל המסמכים              │  │
│  │                                              │  │
│  │        [אישור סיום ההעלאה]                   │  │
│  └─────────────────────────────────────────────┘  │
│                                                     │
│  ─────────────────────────────────────────────────  │
│  שאלות? צרו קשר: [טלפון] | [אימייל]               │
└─────────────────────────────────────────────────────┘
```

### פעולות בפורטל

| פעולה | מה קורה |
|-------|---------|
| כניסה ראשונה | סטטוס → in_progress, מתעדכן תאריך גישה |
| העלאת קובץ | נשמר ב-Storage, נוצרת רשומה ב-documents |
| מחיקת קובץ | נמחק מ-Storage ומהטבלה |
| לחיצה "סיימתי" | סטטוס → documents_received |

### אבטחה בפורטל

- **אין צורך בהתחברות** - גישה לפי token בלבד
- **Token ייחודי** - 24 bytes מקודד Base64
- **RLS מאפשר**:
  - קריאת פרטי ההצהרה
  - העלאת מסמכים
  - מחיקת מסמכים שהלקוח העלה
  - סימון סיום
- **RLS חוסם**:
  - גישה להצהרות אחרות
  - שינוי פרטי ההצהרה
  - גישה למידע רגיש

---

## 8. מכתב ההצהרה

### מיקום התבנית
```
templates/bodies/capital-declaration/capital-declaration.html
```

### משתנים בתבנית

| משתנה | תיאור | דוגמה |
|-------|-------|-------|
| `{{contact_name}}` | שם הנמען | ישראל ישראלי |
| `{{tax_year}}` | שנת מס | 2024 |
| `{{declaration_date}}` | תאריך הצהרה | 01/01/2025 |
| `{{portal_link}}` | לינק לפורטל | https://... |
| `{{letter_date}}` | תאריך המכתב | 02/01/2026 |

### מבנה המכתב

```
┌─────────────────────────────────────────────────────┐
│  [לוגו המשרד]                                       │
│                                                     │
│  הצהרת הון ליום [תאריך] - רשימת מסמכים נדרשים     │
│                                                     │
│  שלום [שם],                                        │
│                                                     │
│  • נבקש להעביר מסמכים להכנת הצהרת ההון            │
│  • ההגשה נדרשת עד [X] ימים                        │
│  • העלו את המסמכים בלינק המצורף                   │
│                                                     │
│  ⚠️ זה לא מסובך!                                   │
│  רוב המסמכים ניתן להשיג באפליקציות הבנקים          │
│                                                     │
│  ═══════════════════════════════════════════════   │
│                                                     │
│  🏦 בנק                                            │
│  ────────────────────────────────────────────────   │
│  • אישורי יתרות מכל הבנקים                        │
│  • דפי חשבון לתאריך ההצהרה                        │
│                                                     │
│  🏠 נדל"ן                                          │
│  ────────────────────────────────────────────────   │
│  • נסחי טאבו עדכניים                               │
│  • שומות ארנונה                                   │
│  • חוזי שכירות                                    │
│                                                     │
│  💰 קופות גמל וביטוח                              │
│  ────────────────────────────────────────────────   │
│  • דוחות שנתיים מקופות הגמל                       │
│  • פוליסות ביטוח חיים                             │
│                                                     │
│  🚗 רכבים                                          │
│  ────────────────────────────────────────────────   │
│  • רישיון רכב                                      │
│  • מסמכי ליסינג/מימון                             │
│                                                     │
│  🌍 נכסים בחו"ל                                    │
│  ────────────────────────────────────────────────   │
│  • דפי חשבון בנק בחו"ל                            │
│  • מסמכי נכסים בחו"ל                              │
│                                                     │
│  📋 נכסים/חובות נוספים                            │
│  ────────────────────────────────────────────────   │
│  • הלוואות                                        │
│  • תיקי השקעות                                    │
│  • קרנות נאמנות                                   │
│                                                     │
│  ═══════════════════════════════════════════════   │
│                                                     │
│  🔴 חשוב! יש להגיש תוך X ימים                     │
│     WhatsApp: 054-XXX-XXXX                         │
│                                                     │
│  🟢 שלחו מסמכים בווטסאפ ברגע שמקבלים              │
│                                                     │
│  ┌─────────────────────────────────────────────┐  │
│  │                                              │  │
│  │   להעלאת המסמכים - לחצו כאן                 │  │
│  │   [כפתור לפורטל]                            │  │
│  │                                              │  │
│  └─────────────────────────────────────────────┘  │
│                                                     │
│  שאלות? אנחנו כאן לעזור.                          │
│                                                     │
│  בברכה,                                            │
│  [שם המשרד]                                        │
│  [חתימה]                                           │
└─────────────────────────────────────────────────────┘
```

---

## 9. ניהול קנסות

### מתי מופעל?
כשמסמנים `was_submitted_late = true` בהגשה

### סטטוסי קנס

| סטטוס | תווית | צבע | משמעות |
|-------|-------|-----|--------|
| `received` | התקבל קנס | אדום | הודעת קנס התקבלה |
| `appeal_submitted` | הוגש ערעור | צהוב | ערעור בטיפול |
| `cancelled` | בוטל | אפור | הקנס בוטל |
| `paid_by_client` | שולם ע"י לקוח | ירוק | הלקוח שילם |
| `paid_by_office` | שולם ע"י משרד | כחול | המשרד שילם |

### שדות קנס

```
penalty_amount          סכום הקנס המקורי (₪)
penalty_status          סטטוס הקנס
penalty_received_date   תאריך קבלת הקנס
penalty_notes           הערות כלליות

appeal_date             תאריך הגשת ערעור
appeal_notes            פרטי הערעור

penalty_paid_date       תאריך תשלום
penalty_paid_amount     סכום ששולם בפועל
penalty_paid_by         מי שילם (client/office)
```

### תהליך טיפוסי

```
1. הגשה באיחור → was_submitted_late = true
2. מגיע קנס:
   - penalty_amount = 5000
   - penalty_status = 'received'
   - penalty_received_date = היום
3. החלטה:

   אפשרות א' - ערעור:
   - penalty_status = 'appeal_submitted'
   - appeal_date = תאריך ההגשה
   - appeal_notes = "ביקשנו פטור בשל נסיבות X"

   אפשרות ב' - תשלום:
   - penalty_status = 'paid_by_client' (או office)
   - penalty_paid_date = תאריך התשלום
   - penalty_paid_amount = 5000 (או סכום מופחת)

   אפשרות ג' - ביטול:
   - penalty_status = 'cancelled'
   - penalty_notes = "הערעור התקבל"
```

---

## 10. תקשורת ותיעוד

### סוגי תקשורת

| סוג | אייקון | שימוש |
|-----|--------|-------|
| `letter` | ✉️ | מכתב שנשלח |
| `phone_call` | 📞 | שיחת טלפון |
| `whatsapp` | 💬 | הודעת WhatsApp |
| `note` | 📝 | הערה פנימית |

### שדות תקשורת

```
communication_type   סוג התקשורת
direction           outbound (יוצאת) / inbound (נכנסת)
subject             נושא
content             תוכן
outcome             תוצאה/סיכום
letter_id           קישור למכתב (אם רלוונטי)
communicated_at     מתי התקשורת התבצעה
created_by          מי תיעד
```

### כפתור WhatsApp

מייצר לינק מוכן עם הודעה:
```
שלום [שם],
אני [שם רו"ח] ממשרד [שם משרד].
בנושא הצהרת הון לשנת [שנה] -
להעלאת מסמכים: [לינק פורטל]
```

---

## 11. שירותים וקבצים

### קבצי קוד עיקריים

| קובץ | תיאור | שורות |
|------|-------|-------|
| `src/types/capital-declaration.types.ts` | טיפוסים והגדרות | ~573 |
| `src/services/capital-declaration.service.ts` | שירות מאומת | ~1,270 |
| `src/services/capital-declaration-public.service.ts` | שירות ציבורי | ~291 |
| `src/pages/CapitalDeclarationPage.tsx` | דף יצירה | |
| `src/pages/CapitalDeclarationsListPage.tsx` | דשבורד | |
| `src/pages/CapitalDeclarationDetailPage.tsx` | דף פרטים | |
| `src/pages/CapitalDeclarationPortal.tsx` | פורטל לקוח | |

### קומפוננטות

```
src/components/capital-declarations/
├── index.ts
├── PriorityBadge.tsx
├── AssignAccountantSelect.tsx
├── WhatsAppReminderButton.tsx
├── LateSubmissionIndicator.tsx
├── SubmissionScreenshotLink.tsx
├── PenaltyStatusBadge.tsx
├── PenaltyManagementCard.tsx
├── LogCommunicationDialog.tsx
├── SendReminderDialog.tsx
├── StatusChangeDialog.tsx
└── CommunicationHistoryCard.tsx
```

### מיגרציות

```
supabase/migrations/
├── 20251218_capital_declaration_system.sql      (מערכת בסיסית)
├── 20251220_capital_declaration_status_history.sql (היסטוריית סטטוס)
├── 20251222_add_general_category_to_capital_declaration.sql (קטגוריה כללית)
├── 20251225_add_documents_received_status.sql   (סטטוס מסמכים התקבלו)
└── 20251228_add_penalty_management.sql          (ניהול קנסות)
```

### תבנית מכתב

```
templates/bodies/capital-declaration/
└── capital-declaration.html
```

---

## 12. הרשאות ואבטחה

### משתמשים מאומתים

| תפקיד | הרשאות |
|-------|--------|
| Admin | הכל - כולל הקצאה, עדיפות, מחיקה |
| Accountant | צפייה במוקצים, שינוי סטטוס, תיעוד תקשורת |
| Bookkeeper | צפייה בלבד |

### גישה ציבורית (Token)

**מותר**:
- קריאת פרטי ההצהרה (חלקי)
- העלאת מסמכים
- מחיקת מסמכים שהעלה
- סימון סיום העלאה

**חסום**:
- גישה להצהרות אחרות
- שינוי פרטים
- מחיקת ההצהרה
- גישה למידע רגיש (IP, tenant_id פנימי)

### RLS Policies עיקריות

```sql
-- משתמשים מאומתים - גישה לטננט שלהם
CREATE POLICY "Users can access their tenant declarations"
ON capital_declarations FOR ALL
USING (tenant_id = get_current_tenant_id());

-- גישה ציבורית לקריאה בלבד עם טוקן
CREATE POLICY "Public can read by token"
ON capital_declarations FOR SELECT
USING (public_token = current_setting('app.current_token', true));

-- גישה ציבורית להעלאת מסמכים עם טוקן
CREATE POLICY "Public can upload documents"
ON capital_declaration_documents FOR INSERT
WITH CHECK (
  declaration_id IN (
    SELECT id FROM capital_declarations
    WHERE public_token = current_setting('app.current_token', true)
  )
);
```

### פונקציות RPC

```sql
-- קבלת הצהרה לפי טוקן (ציבורי)
get_declaration_by_token(p_token TEXT)

-- מעקב גישה לפורטל
track_declaration_portal_access(p_token TEXT)

-- ספירת מסמכים לפי קטגוריה
get_declaration_document_counts(p_declaration_id UUID)

-- סימון סיום העלאה (ציבורי)
mark_declaration_complete(p_token TEXT)
```

---

## נספח: תרשים זרימה

```
┌──────────────────────────────────────────────────────────────────┐
│                        יצירת הצהרה (רו"ח)                        │
└──────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌──────────────────────────────────────────────────────────────────┐
│                      מילוי טופס + תצוגה מקדימה                    │
└──────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌──────────────────────────────────────────────────────────────────┐
│                   יצירת הצהרה + PDF + לינק פורטל                  │
│                         status = 'sent'                          │
└──────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌──────────────────────────────────────────────────────────────────┐
│                    שליחת לינק ללקוח (אימייל/SMS)                  │
└──────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌──────────────────────────────────────────────────────────────────┐
│                      לקוח נכנס לפורטל                            │
│                    status = 'in_progress'                        │
└──────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌──────────────────────────────────────────────────────────────────┐
│                    לקוח מעלה מסמכים לקטגוריות                    │
│                  status = 'waiting_documents'                    │
└──────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌──────────────────────────────────────────────────────────────────┐
│               לקוח לוחץ "סיימתי להעלות"                          │
│                status = 'documents_received'                     │
└──────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌──────────────────────────────────────────────────────────────────┐
│                    רו"ח בודק מסמכים                              │
│                    status = 'reviewing'                          │
└──────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌──────────────────────────────────────────────────────────────────┐
│                   הכנת ההצהרה                                    │
│              status = 'in_preparation'                           │
└──────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌──────────────────────────────────────────────────────────────────┐
│                  ממתין לאישור מנהל                               │
│              status = 'pending_approval'                         │
└──────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌──────────────────────────────────────────────────────────────────┐
│             הגשה לרשות המסים + צילום מסך                        │
│                    status = 'submitted'                          │
│              was_submitted_late = true/false                     │
└──────────────────────────────────────────────────────────────────┘
                                │
                    ┌───────────┴───────────┐
                    │                       │
            ▼ (אם באיחור)                   ▼ (בזמן)
┌─────────────────────────┐     ┌─────────────────────────┐
│    ניהול קנסות          │     │      סיום תהליך         │
│ - קבלת קנס              │     │                         │
│ - ערעור / תשלום         │     │                         │
└─────────────────────────┘     └─────────────────────────┘
```

---

## סיכום

מערכת הצהרות ההון היא מערכת מקיפה המאפשרת:

1. **יצירה קלה** - טופס פשוט עם השלמה אוטומטית
2. **שליחה ללקוח** - PDF מעוצב + לינק לפורטל
3. **חוויית לקוח נוחה** - ללא התחברות, drag & drop
4. **מעקב מלא** - סטטוסים, היסטוריה, תקשורת
5. **ניהול דד-ליינים** - רשות המסים + פנימי
6. **ניהול קנסות** - מעקב מלא אחר קנסות וערעורים
7. **אבטחה** - RLS, tokens, הרשאות לפי תפקיד

המערכת בנויה ל-Multi-tenant ותומכת במשרדים מרובים עם הפרדה מלאה.
